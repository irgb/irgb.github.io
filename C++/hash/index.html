<!DOCTYPE html><html lang="en"><head><meta name="google-site-verification" content="8STslQB6oQuQonukDzpOMhY1irA5r0Feoc4VDSXpodg"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Hash | Irgb</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Hash</h1><a id="logo" href="/.">Irgb</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/guestbook/"><i class="fa fa-comments"> Guestbook</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Hash</h1><div class="post-meta">May 14, 2018<span> | </span><span class="category"><a href="/categories/algorithm/">algorithm</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Views</span></span></div><a data-disqus-identifier="C++/hash/" href="/C++/hash/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="hash-函数"><a href="#hash-函数" class="headerlink" title="hash 函数"></a>hash 函数</h3><p>比较常用的是 <a href="https://github.com/aappleby/smhasher/wiki/MurmurHash3" target="_blank" rel="noopener">murmurhash3</a> :<br><strong>murmurhash3.h</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MURMURHASH3_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MURMURHASH3_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Referenec: https://github.com/goossaert/hashmap</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">murmurhash3_x64_128</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* key, <span class="keyword">int</span> len, <span class="keyword">uint32_t</span> seed, <span class="keyword">void</span> * out)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MURMURHASH3_H_</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>murmurhash3.cpp</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"murmurhash3.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FORCE_INLINE inline __attribute__((always_inline))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> uint64_t <span class="title">rotl64</span> <span class="params">(<span class="keyword">uint64_t</span> x, <span class="keyword">int8_t</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x &lt;&lt; r) | (x &gt;&gt; (<span class="number">64</span> - r));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROTL64(x, y) rotl64(x, y)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIG_CONSTANT(x) (x##LLU)</span></span><br><span class="line"></span><br><span class="line"><span class="function">FORCE_INLINE uint64_t <span class="title">getblock64</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">uint64_t</span> * p, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FORCE_INLINE uint64_t <span class="title">fmix64</span> <span class="params">(<span class="keyword">uint64_t</span> k)</span> </span>&#123;</span><br><span class="line">    k ^= k &gt;&gt; <span class="number">33</span>;</span><br><span class="line">    k *= BIG_CONSTANT(<span class="number">0xff51afd7ed558ccd</span>);</span><br><span class="line">    k ^= k &gt;&gt; <span class="number">33</span>;</span><br><span class="line">    k *= BIG_CONSTANT(<span class="number">0xc4ceb9fe1a85ec53</span>);</span><br><span class="line">    k ^= k &gt;&gt; <span class="number">33</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">murmurhash3_x64_128</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> * key, <span class="keyword">const</span> <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="keyword">uint32_t</span> seed, <span class="keyword">void</span> * out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * data = (<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)key;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> nblocks = len / <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> h1 = seed;</span><br><span class="line">    <span class="keyword">uint64_t</span> h2 = seed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> c1 = BIG_CONSTANT(<span class="number">0x87c37b91114253d5</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> c2 = BIG_CONSTANT(<span class="number">0x4cf5ad432745937f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// body</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> * blocks = (<span class="keyword">const</span> <span class="keyword">uint64_t</span> *)(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; nblocks; i++) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> k1 = getblock64(blocks,i*<span class="number">2</span>+<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> k2 = getblock64(blocks,i*<span class="number">2</span>+<span class="number">1</span>);</span><br><span class="line">        k1 *= c1; k1    = ROTL64(k1,<span class="number">31</span>); k1 *= c2; h1 ^= k1;</span><br><span class="line">        h1 = ROTL64(h1,<span class="number">27</span>); h1 += h2; h1 = h1*<span class="number">5</span>+<span class="number">0x52dce729</span>;</span><br><span class="line">        k2 *= c2; k2    = ROTL64(k2,<span class="number">33</span>); k2 *= c1; h2 ^= k2;</span><br><span class="line">        h2 = ROTL64(h2,<span class="number">31</span>); h2 += h1; h2 = h2*<span class="number">5</span>+<span class="number">0x38495ab5</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tail</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * tail = (<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)(data + nblocks*<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> k1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> k2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (len &amp; <span class="number">15</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">15</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[<span class="number">14</span>]) &lt;&lt; <span class="number">48</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">14</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[<span class="number">13</span>]) &lt;&lt; <span class="number">40</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">13</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[<span class="number">12</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">12</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[<span class="number">11</span>]) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">11</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[<span class="number">10</span>]) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">10</span>: k2 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">9</span>]) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">9</span> : k2 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">8</span>]) &lt;&lt; <span class="number">0</span>;</span><br><span class="line">				 k2 *= c2; k2 = ROTL64(k2,<span class="number">33</span>); k2 *= c1; h2 ^= k2;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">8</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">7</span>]) &lt;&lt; <span class="number">56</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">7</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">6</span>]) &lt;&lt; <span class="number">48</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">6</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">5</span>]) &lt;&lt; <span class="number">40</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">5</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">4</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">3</span>]) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">2</span>]) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">1</span>]) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>: k1 ^= ((<span class="keyword">uint64_t</span>)tail[ <span class="number">0</span>]) &lt;&lt; <span class="number">0</span>;</span><br><span class="line">				 k1 *= c1; k1 = ROTL64(k1,<span class="number">31</span>); k1 *= c2; h1 ^= k1;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------</span></span><br><span class="line">    <span class="comment">// finalization</span></span><br><span class="line"></span><br><span class="line">    h1 ^= len; h2 ^= len;</span><br><span class="line"></span><br><span class="line">    h1 += h2;</span><br><span class="line">    h2 += h1;</span><br><span class="line"></span><br><span class="line">    h1 = fmix64(h1);</span><br><span class="line">    h2 = fmix64(h2);</span><br><span class="line"></span><br><span class="line">    h1 += h2;</span><br><span class="line">    h2 += h1;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">uint64_t</span>*)out)[<span class="number">0</span>] = h1;</span><br><span class="line">    ((<span class="keyword">uint64_t</span>*)out)[<span class="number">1</span>] = h2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>调用方法</strong>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> out[<span class="number">16</span>];</span><br><span class="line"><span class="keyword">uint64_t</span> key = <span class="number">98723849823</span>;</span><br><span class="line">murmurhash3_x64_128((<span class="keyword">void</span>*)(&amp;key), <span class="keyword">sizeof</span>(key), <span class="number">0</span>, out);</span><br><span class="line"><span class="keyword">uint64_t</span> hashcode = *((<span class="keyword">uint64_t</span>*) out) ^ *((<span class="keyword">uint64_t</span>*) (out + <span class="number">8</span>));<span class="comment">// xor 不改变随机数分布</span></span><br></pre></td></tr></table></figure></p>
<h3 id="hash-表冲突解决策略"><a href="#hash-表冲突解决策略" class="headerlink" title="hash 表冲突解决策略:"></a>hash 表冲突解决策略:</h3><p>比较常用的是 robin hood hashing:<br><strong>robin_hood_hash.hpp</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ROBIN_HOOD_HASHTABLE_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROBIN_HOOD_HASHTABLE_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> likely(x) __builtin_expect(!!(x), 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据具体场景优化定制的的 robin hood hashtable, 通用型不强.</span></span><br><span class="line"><span class="comment">// key 的类型为 uint64_t, 即 winfoid 的类型, value 的类型为 uint32_t.</span></span><br><span class="line"><span class="comment">// 只支持插入和查找, 不支持删除, 不支持自动扩容.</span></span><br><span class="line"><span class="comment">// 使用时需要用户自己指定 capacity, 这个 capacity 决定了最终的 load factor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint64_t</span> K;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> V;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RobinHoodHashtable</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Item</span> &#123;</span></span><br><span class="line">        K key;</span><br><span class="line">        V value;</span><br><span class="line">        Item() : key(<span class="number">0</span>), value(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">        Item(K k, V v) : key(k), value(v) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    RobinHoodHashtable(): _capacity(<span class="number">0</span>), _item_num(<span class="number">0</span>), _buffer(<span class="literal">nullptr</span>), _probing_num(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    ~RobinHoodHashtable() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_buffer != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">delete</span> [] _buffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (_probing_num != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">delete</span> [] _probing_num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 hashtable, 设置 capacity</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">(<span class="keyword">uint32_t</span> capacity)</span> </span>&#123;</span><br><span class="line">        _capacity = capacity;</span><br><span class="line">        _buffer = <span class="keyword">new</span> (<span class="built_in">std</span>::nothrow) Item[_capacity];</span><br><span class="line">        <span class="keyword">if</span> (_buffer == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"new buffer array failed."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _probing_num = <span class="keyword">new</span> (<span class="built_in">std</span>::nothrow) <span class="keyword">int32_t</span>[_capacity];</span><br><span class="line">        <span class="keyword">if</span> (_probing_num == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"new probing_num array failed."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::fill_n(_probing_num, _capacity, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">insert</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (_item_num &gt;= _capacity) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"you need to increase capacity"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> pos = _key_to_pos(key);</span><br><span class="line">        <span class="keyword">uint32_t</span> probing_count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果 pos 未被占用就放在这个位置</span></span><br><span class="line">            <span class="keyword">if</span> (_probing_num[pos] == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">new</span> (_buffer + pos) Item(key, value);</span><br><span class="line">                _probing_num[pos] = probing_count;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 相同的 key 就覆盖 value</span></span><br><span class="line">            <span class="keyword">if</span> (key == _buffer[pos].key) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则继续探测下一个位置</span></span><br><span class="line">            <span class="keyword">uint32_t</span> cur_probing_count = _probing_num[pos];</span><br><span class="line">            <span class="keyword">if</span> (probing_count &gt; cur_probing_count) &#123;</span><br><span class="line">                <span class="built_in">std</span>::swap(key, _buffer[pos].key);</span><br><span class="line">                <span class="built_in">std</span>::swap(value, _buffer[pos].value);</span><br><span class="line">                _probing_num[pos] = probing_count;</span><br><span class="line">                probing_count = cur_probing_count;</span><br><span class="line">            &#125;</span><br><span class="line">            pos = ++pos &gt;= _capacity ? pos % _capacity : pos;</span><br><span class="line">            ++probing_count;</span><br><span class="line">        &#125;</span><br><span class="line">        ++_item_num;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 key 查找, 如果找到返回 &lt;true, value&gt;, 没有找到返回&lt;false, 0&gt;</span></span><br><span class="line">    __attribute__((always_inline)) <span class="built_in">std</span>::pair&lt;<span class="keyword">bool</span>, V&gt; find(<span class="keyword">const</span> K&amp; key) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> pos = _key_to_pos(key);</span><br><span class="line">        <span class="keyword">uint32_t</span> probing_count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_probing_num[pos] == <span class="number">-1</span> || probing_count &gt; _probing_num[pos]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">std</span>::make_pair(<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_buffer[pos].key == key) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">std</span>::make_pair(<span class="literal">true</span>, _buffer[pos].value);</span><br><span class="line">            &#125;</span><br><span class="line">            pos = ++pos &gt;= _capacity ? pos % _capacity : pos;</span><br><span class="line">            ++probing_count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">uint32_t</span> _item_num;</span><br><span class="line">    <span class="keyword">uint32_t</span> _capacity;</span><br><span class="line">    <span class="comment">// 存储 k-v 对的缓冲区</span></span><br><span class="line">    Item * _buffer;</span><br><span class="line">    <span class="comment">// 记录一个元素的探测长度, -1 表示当前位置没有元素</span></span><br><span class="line">    <span class="keyword">int32_t</span>* _probing_num;</span><br><span class="line">    <span class="comment">// 将 key 转换为pos, 通常可以通过murmurhash3_x64_128(key) 计算 hashcode, 然后在计算 pos, 但实验发现 murmurhash3_x64_128 本身也比较耗时, 直接对 key 进行取余效率更高. 但这种情况只适合数据分布比较均匀的情况, 否则有可能出现insert 和 find 冲突大大增加的情况.</span></span><br><span class="line">    __attribute__((always_inline)) <span class="keyword">uint32_t</span> _key_to_pos(<span class="keyword">const</span> K&amp; key) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span>* p = (<span class="keyword">uint32_t</span>*) &amp;key;</span><br><span class="line">        <span class="keyword">uint32_t</span> hashcode = *p ^ *(p+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">uint32_t</span> pos = hashcode &gt;= _capacity ? hashcode % _capacity : hashcode;</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// ROBIN_HOOD_HASHTABLE_H_</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://www.sebastiansylvan.com/post/robin-hood-hashing-should-be-your-default-hash-table-implementation/" target="_blank" rel="noopener">Robin Hood Hashing should be your default Hash Table implementation</a></li>
<li><a href="http://www.idryman.org/blog/2017/05/03/writing-a-damn-fast-hash-table-with-tiny-memory-footprints/" target="_blank" rel="noopener">Writing a Damn Fast Hash Table With Tiny Memory Footprints</a></li>
<li><a href="http://codecapsule.com/2013/11/11/robin-hood-hashing/" target="_blank" rel="noopener">Robin Hood hashing</a></li>
<li><a href="https://tessil.github.io/2016/08/29/benchmark-hopscotch-map.html" target="_blank" rel="noopener">Benchmark of major hash maps implementations</a></li>
<li><a href="https://probablydance.com/2017/02/26/i-wrote-the-fastest-hashtable/" target="_blank" rel="noopener">I Wrote The Fastest Hashtable</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://irgb.github.io/C++/hash/" data-id="cjh695maq003d6ipkxf2a4g7l" class="article-share-link">Share</a><div class="tags"><a href="/tags/algorithm-hash/">algorithm hash</a></div><div class="post-nav"><a href="/利用非对称加密传输文件/" class="pre"></a><a href="/如何重写库函数或系统调用/" class="next">重写库函数或系统调用</a></div><div id="disqus_thread"><script>var disqus_shortname = 'linjapyc';
var disqus_identifier = 'C++/hash/';
var disqus_title = 'Hash';
var disqus_url = 'https://irgb.github.io/C++/hash/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//linjapyc.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Google Search"/><input type="hidden" name="sitesearch" value="https://irgb.github.io"/></form></div><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Local Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/c/">c++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/coding/">coding</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fun/">fun</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/genetic/" style="font-size: 15px;">genetic</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/TLS/" style="font-size: 15px;">TLS</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/travis/" style="font-size: 15px;">travis</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/websocket/" style="font-size: 15px;">websocket</a> <a href="/tags/c-tools/" style="font-size: 15px;">c++ tools</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/heap/" style="font-size: 15px;">heap</a> <a href="/tags/sort/" style="font-size: 15px;">sort</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/fun/" style="font-size: 15px;">fun</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/graph/" style="font-size: 15px;">graph</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/c-design-pattern-factory-pattern/" style="font-size: 15px;">c++ design-pattern factory-pattern</a> <a href="/tags/c-gcc/" style="font-size: 15px;">c++ gcc</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/algorithm-hash/" style="font-size: 15px;">algorithm hash</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/利用非对称加密传输文件/">利用非对称加密传输文件</a></li><li class="post-list-item"><a class="post-list-link" href="/C++/hash/">Hash</a></li><li class="post-list-item"><a class="post-list-link" href="/如何重写库函数或系统调用/">重写库函数或系统调用</a></li><li class="post-list-item"><a class="post-list-link" href="/C++线程优雅退出/">C++ 线程优雅退出</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql 常用命令/">mysql 常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/gperftools 安装与使用/">gperftools</a></li><li class="post-list-item"><a class="post-list-link" href="/C++/atomic_vs_lock/">C++ atomic, lock 性能对比</a></li><li class="post-list-item"><a class="post-list-link" href="/德州扑克/">德州扑克（texas poker)</a></li><li class="post-list-item"><a class="post-list-link" href="/C++/ C++工厂模式/">C++ 工厂模式</a></li><li class="post-list-item"><a class="post-list-link" href="/C++/C++代码调试/">C++ 代码调试</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Irgb.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-92562797-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>